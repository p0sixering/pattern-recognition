<!DOCTYPE html>
<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link href="main.css" rel="stylesheet" type="text/css">

<!-- Synth scripts from Stuart Memo:  http://stuartmemo.com/synth/ -->
<script src="tsw.js"></script>
<script src="synth.js"></script>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js" ></script>
<script type="text/javascript" src="raphael-min.js"></script>
<script type="text/javascript" src="shapes.js"></script>
<script type="text/javascript" src="buttons.js"></script>
<script type="text/javascript" src="layouts.js"></script>
<script type="text/javascript" src="mod-functions.js"></script>
<script type="text/javascript" src="sort.js"></script>
<script type="text/javascript" src="scales.js"></script>
<script type="text/javascript" src="mappings.js"></script>
</head>

<body>
<script type="text/javascript">

// From http://stackoverflow.com/questions/321113/
function partial(func /*, 0..n args */) {
  var args = Array.prototype.slice.call(arguments, 1);
  return function() {
    var allArguments = args.concat(Array.prototype.slice.call(arguments));
    return func.apply(this, allArguments);
  };
}


// Globals: button data, things about the canvas, etc
var buttonData = [];
var paper;
var offset;
var buttonBrush = {};


// Functions to draw sample layouts.
function drawExamplePiano() {
    makePiano(paper, {x:75, y:200}, 20, '#11BB00', 'circle', {x:50, y:50}, 0, {}, 1);
}

function drawExampleXylophone() {
    makeLine(paper, {x: 50, y: 150}, 8, 5, 0, '#AA0000', 'triangle', {x:25, y:25}, 0, {});
}

function drawExampleZither() {
    makeZither(paper, {x:145, y:25}, 8, 25, '#900FF0', 'rectangle',  {x:25, y:15}, 0, {}, 'right');
}

function drawExamplePianoRoll() {
    makePianoRoll(paper, {x: 500, y: 25}, 15, '#0A0B0C', 'diamond', {x:25, y:25}, 0, {}, 0.47);  
}

function drawExampleSmallGrid() {
    makeColumnGrid(paper, {x:450, y:100}, 2, 3, {x: 20, y:10}, 0, '#0900BB', 'hexagon', {x:50, y:50}, 0, {});
}

function drawExampleLargeGrid() {
    makeColumnGrid(paper, {x:100, y:100}, 7, 5, {x: 20, y:10}, 0, '#AA1599', 'octagon', {x:25, y:25}, 0, {});    
}

function drawExampleBigPiano() {
    makeBigPiano(paper, {x:50, y:400}, 10, '#123456', 'circle', {x:15, y:15}, 0, {}, 1);
}

function clearCanvas() {
    paper.clear();
    buttonData = [];

    // Make sure that we remove the click function, and then make it again..
    $('svg').off('click');
    $('svg').click(function(e) {
        createButton(e);
    });
    $('#result-info').text('');

    updatePreview();
}

// We can't JSONify the DOM reference in buttonData, 
// so we take it out before sending the data to the server.
// We also set the mapping flag here.
function prepButtonData(mappingFlag) {
    cleanedButtonData = [];
    for (var i = 0; i < buttonData.length; i++) {
        cleanButton = {};
        keys = Object.keys(buttonData[i]);
        for (var j = 0; j < keys.length; j++) {
            if (keys[j] != 'button') {
                cleanButton[keys[j]] = buttonData[i][keys[j]];
            }
        }
        cleanedButtonData.push(cleanButton);
    } 

    var preppedButtonData = {};

    preppedButtonData['mapping-flag'] = mappingFlag;
    preppedButtonData['locations'] = cleanedButtonData

    return preppedButtonData;
}

function sendDataToServer() {
    // Remove the click-to-make-a-button, update preview
    $('svg').off('click');
    playbackPreview();

    var url = "http://quiet-wildwood-4860.herokuapp.com/analysis";
    var mappingFlag = true;

    preppedButtonData = prepButtonData(mappingFlag);
    var body = JSON.stringify(preppedButtonData);
    var req = new XMLHttpRequest();
    if ('withCredentials' in req) {
        req.open('POST', url, true);
        req.setRequestHeader('Content-Type', 'application/json');
        req.onreadystatechange = function() {
                if (req.readyState === 4) {
                    if (req.status >= 200 && req.status < 400) {
                        var jsonRes = JSON.parse(req.responseText);

                        $('#result-info').text(jsonRes['result']);

                        if ('mapping' in jsonRes) {
                            applyKnownMapping(jsonRes['mapping'])
                        } else {
                            console.log(req.responseText);
                            applyMapping(jsonRes['result']);
                        }

                    } else {
                        console.log('Response returned with non-OK status');
                    }
                }
            };
        req.send(body);
    }
}

// Takes a list of buttonData, with mapping info, and applies it.
function applyKnownMapping(returnedButtonData) {
    console.log(returnedButtonData);
    for (var i = 0; i < buttonData.length; i++) {
        // find the match in returnedButtonData, 
        for (var j = 0; j < returnedButtonData.length; j++) {
            if (buttonData[i].location.x == returnedButtonData[j].location.x && buttonData[i].location.y == returnedButtonData[j].location.y) {
                noteFreq = midiNoteToFrequency(returnedButtonData[j].noteNumber);
                console.log('matched', returnedButtonData[j].noteNumber);
                break;
            }
        }
      
        // make the synth & apply the function
        var synth = new Synth({
            context: tsw.context(),
            speakersOn: true
        });
        var mouseDownFunc = partial(betterNoteClick, synth, noteFreq);
        var mouseUpFunc = partial(betterNoteStop, synth, noteFreq);
        buttonData[i].button.node.addEventListener('mousedown', mouseDownFunc);
        buttonData[i].button.node.addEventListener('mouseup', mouseUpFunc);
    } // end for i
}

// Function that apples the apropriate mapping,
// based on the server response.
function applyMapping(result) {
    if (result == 'piano') {
        buttonData = orderFromLeft(buttonData);
        mapScaleOrdered(buttonData, 60, 'chromatic');
    } else if (result == 'xylophone') {
        buttonData = orderFromLeft(buttonData);
        mapScaleOrdered(buttonData, 60, 'diatonicMajor');
    } else if (result == 'small_grid') {
        mapAsSmallGrid(buttonData);
    } else if (result == 'zither') {
        buttonData = orderFromBottom(buttonData);
        mapScaleOrdered(buttonData, 60, 'diatonicMajor');
    } else if (result == 'piano_roll') {
        buttonData = orderFromBottom(buttonData);
        mapScaleOrdered(buttonData, 60, 'chromatic');
    } else if (result == 'large_grid') {
        mapAsLargeGrid(buttonData);
    } else if (result == 'big_piano') {
        buttonData = orderFromLeft(buttonData);
        mapScaleOrdered(buttonData, 60, 'chromatic');
    }
}

// onClick function to create buttons
// Currently with dummy params
function createButton(e) {
    var location = {'x': e.pageX - offset.x, 'y': e.pageY - offset.y}

    var colorVal = $('#color-input')[0].value;
    var color = colorVal;

    var shapeVal = $('#shape-slider')[0].value;
    var shape = allShapes[shapeVal];

    var radiusVal = $('#radius-slider')[0].value;
    var radius = {'x': radiusVal, 'y': radiusVal};

    var rotation = 0;
    makeButton(paper, location, color, shape, radius, rotation, {}, 0);
}


function updatePreview() {
    var radiusVal = $('#radius-slider')[0].value;
    var radius = radiusVal.toString() + 'px';
    $('#radius-info').text(radius);

    var shapeVal = $('#shape-slider')[0].value;
    var shape = allShapes[shapeVal];
    $('#shape-info').text(shape);

    $('#button-info').css('color', $('#color-input')[0].value)
}

function playbackPreview() {
    $('#shape-info').text('');
    $('#radius-info').text('-playback-');
    $('#button-info').css('color', '#00FF33');
}

function init() {
    // Creates canvas.
    var screensize = {x: 1024, y: 512};
    offset = {'x': 250, 'y':  25};
    paper = Raphael(offset.x, offset.y, screensize.x, screensize.y);

    // Assign the button creation function to clicking on the canvas
    $('svg').click(function(e) {
        createButton(e);
    });

    // Update the preview functions
    $('#color-input').change(function() {
        updatePreview();
    });

    $('#shape-slider').change(function() {
        updatePreview();
    });

    $('#radius-slider').change(function() {
        updatePreview();
    });

    // Samples that we don't know how to map, yet..
    //makeCircle(paper, {x:400, y:400}, 200, 10, '#AA0000', 'rectangle', {x:10, y:10}, 0, modFunctions);
    //makeRadial(paper, {x:400, y:200}, Math.PI, 5, 5, 55, '#AA0000', 'circle', {x:25, y:25}, 0, {});

    // Intial load of preview
    updatePreview();
}

window.onload = init;
</script>


<h2> pattern recognition </h2>

<div id="controls">
<br />
radius:  <input type="range" name="radius" id="radius-slider" min="5" max="250" value=20><br />

shape:  <input type="range" name="shape" id="shape-slider" min="0" max="7" value=0><br />
colour:  <input type="text" id="color-input" name="color" value="#11AAFF"><br />
<br />

<div id="button-info">
<span id="shape-info"></span> <span id="radius-info"></span>
</div>

<hr />
<button class="all-buttons" id="test-button" onclick="sendDataToServer()">recognize</button>
<button class="all-buttons" id="clear-button" onclick="clearCanvas()">clear</button><br />
<br /><hr />
examples:  <br />
<button class="all-buttons" onclick="drawExamplePiano()">piano</button><br />
<button class="all-buttons" onclick="drawExampleXylophone()">xylophone</button><br />
<button class="all-buttons" onclick="drawExampleZither()">zither</button><br />
<button class="all-buttons" onclick="drawExamplePianoRoll()">piano roll</button><br />
<button class="all-buttons" onclick="drawExampleSmallGrid()">small grid</button><br />
<button class="all-buttons" onclick="drawExampleLargeGrid()">large grid</button><br />
<button class="all-buttons" onclick="drawExampleBigPiano()">big piano</button><br />
</div>

<div id="result-info"></div>

</body>
</html>
