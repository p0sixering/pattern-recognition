<!DOCTYPE html>
<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

<!-- Synth scripts from Stuart Memo:  http://stuartmemo.com/synth/ -->
<script src="tsw.js"></script>
<script src="synth.js"></script>

<script type="text/javascript" src="raphael-min.js"></script>
<script type="text/javascript" src="shapes.js"></script>
<script type="text/javascript" src="buttons.js"></script>
<script type="text/javascript" src="layouts.js"></script>
<script type="text/javascript" src="mod-functions.js"></script>
<script type="text/javascript" src="sort.js"></script>
<script type="text/javascript" src="scales.js"></script>
<script type="text/javascript" src="mappings.js"></script>
</head>

<body>
<script type="text/javascript">

// From http://stackoverflow.com/questions/321113/
function partial(func /*, 0..n args */) {
  var args = Array.prototype.slice.call(arguments, 1);
  return function() {
    var allArguments = args.concat(Array.prototype.slice.call(arguments));
    return func.apply(this, allArguments);
  };
}


// Global button data
var buttonData = [];

// We can't JSONify the DOM reference in buttonData, 
// so we take it out before sending the data to the server.
function cleanButtonData() {
    cleanedButtonData = [];
    for (var i = 0; i < buttonData.length; i++) {
        cleanButton = {};
        keys = Object.keys(buttonData[i]);
        for (var j = 0; j < keys.length; j++) {
            if (keys[j] != 'button') {
                cleanButton[keys[j]] = buttonData[i][keys[j]];
            }
        }
        cleanedButtonData.push(cleanButton);
    } 
    return cleanedButtonData;
}

function sendDataToServer() {
    var url = "http://quiet-wildwood-4860.herokuapp.com/analysis";
    cleanedButtonData = cleanButtonData()
    var body = JSON.stringify(cleanedButtonData);
    var req = new XMLHttpRequest();
    if ('withCredentials' in req) {
        req.open('POST', url, true);
        req.setRequestHeader('Content-Type', 'application/json');
        req.onreadystatechange = function() {
                if (req.readyState === 4) {
                    if (req.status >= 200 && req.status < 400) {
                        // Magic happens here
                        console.log(req.responseText);
                        var jsonRes = JSON.parse(req.responseText);
                        applyMapping(jsonRes['result']);
                    } else {
                        console.log('Response returned with non-OK status');
                    }
                }
            };
        req.send(body);
    }
}


// Function that apples the apropriate mapping,
// based on the server response.
function applyMapping(result) {
    if (result == 'piano') {
        buttonData = orderFromLeft(buttonData);
        mapScaleOrdered(buttonData, 60, 'chromatic');
    } else if (result == 'xylophone') {
        buttonData = orderFromLeft(buttonData);
        mapScaleOrdered(buttonData, 60, 'diatonicMajor');
    } else if (result == 'small grid') {
        mapAsSmallGrid(buttonData);
    } else if (result == 'zither') {
        buttonData = orderFromBottom(buttonData);
        mapScaleOrdered(buttonData, 60, 'diatonicMajor');
    } else if (result == 'piano roll') {
        buttonData = orderFromBottom(buttonData);
        mapScaleOrdered(buttonData, 60, 'chromatic');
    } else if (result == 'large grid') {
        buttonData = orderFromBottom(buttonData);
        mapScaleOrdered(buttonData, 60, 'chromatic');
    } else if (result == 'big piano') {
        mapAsLargeGrid(buttonData);
    }
}

function init() {
    // Creates canvas.
    var screensize = {x: 1024, y:  768}
    var paper = Raphael(100, 100, screensize.x, screensize.y);

    // Set of samples
    // makePiano(paper, {x:50, y:200}, 20, '#AA0000', 'circle', {x:50, y:50}, 0, {}, 1);
    //makeBigPiano(paper, {x:50, y:200}, 10, '#AA0000', 'circle', {x:15, y:15}, 0, {}, 1);
    //makeCircle(paper, {x:400, y:400}, 200, 10, '#AA0000', 'rectangle', {x:10, y:10}, 0, modFunctions);
    //makeLine(paper, {x: 50, y: 150}, 8, 5, 0, '#AA0000', 'circle', {x:25, y:25}, 0, {});
    //makeColumn(paper, {x: 50, y: 100}, 6, 20, '#AA0000', 'circle', {x:50, y:50}, 0, modFunctions);
    //makeRow(paper, {x: 50, y: 100}, 6, 20, '#AA0000', 'circle', {x:50, y:50}, 0, modFunctions);
    //makeRadial(paper, {x:400, y:200}, Math.PI, 5, 5, 55, '#AA0000', 'circle', {x:25, y:25}, 0, {});
    //makeColumnGrid(paper, {x:100, y:100}, 1, 5, {x: 20, y:10}, 0, '#AA0000', 'circle', {x:50, y:50}, 0, {});
    //makeRowGrid(paper, {x:50, y:50}, 3, 5, {x: 20, y:10}, 20, '#AA0000', 'circle', {x:50, y:50}, 0, modFunctions);
    makeZither(paper, {x:145, y:78}, 8, 25, '#909090', 'rectangle',  {x:50, y:20}, 0, {}, 'right');
    // makePianoRoll(paper, {x: 100, y: 100}, 30, '#0A0B0C', 'square', {x:30, y:30}, 0, {}, 0.47);
    // makeColumnGrid(paper, {x:100, y:100}, 10, 5, {x: 20, y:10}, 0, '#AA0000', 'circle', {x:25, y:25}, 0, {});

}

window.onload = init;
</script>

<button id="test-button" onclick="sendDataToServer()">Talk to the server!</button>
</body>
</html>
