<!DOCTYPE html>
<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

<script type="text/javascript" src="raphael-min.js"></script>
<script type="text/javascript" src="shapes.js"></script>
</head>

<body>
<script type="text/javascript">

// From http://stackoverflow.com/questions/321113/
function partial(func /*, 0..n args */) {
  var args = Array.prototype.slice.call(arguments, 1);
  return function() {
    var allArguments = args.concat(Array.prototype.slice.call(arguments));
    return func.apply(this, allArguments);
  };
}

// Click functions
// append with:  circle.click(clickFunction);
function testClick() {
    console.log("click");
}

var allSizes = ['tiny', 'small', 'medium', 'large', 'huge', 'gigantic'];
var buttonData = [];
var butttonDifferences = {};

// I am mising 'area' / any way to disambiguate rectangles
// For rects and ellipses, I should take the larger of the two dimensions
// I should also compute area, dammit

function addButton(b, location, color, shape, radius) {
    // Calculate brightness
    red = parseInt(color.substring(1, 3), 16);
    green = parseInt(color.substring(3, 5), 16);
    blue = parseInt(color.substring(5, 7), 16);
    brightness = red + green + blue / 3;

    // Get side count
    var sides;
    if (shape == 'circle') {
        sides = 0;
    } else if (shape == 'triangle') {
        sides = 3;
    } else if (shape == 'pentagon') {
        sides = 5;
    } else if (shape == 'hexagon') {
        sides = 6;
    } else if (shape == 'octagon') {
        sides = 8;
    } else {
        sides = 4;
    }

    // I am sure there is a cute way to get this programmaticaly, but I won't sweat it for now
    // also I need to sort out "radius" for rectangles
    radius = radius.x;
    var size;
    if (radius < 8) {
        size = 'tiny';
    } else if (radius < 16) {
        size = 'small';
    } else if (radius < 32) {
        size = 'medium';
    } else if (radius < 64) {
        size = 'large';
    } else if (radius < 128) {
        size = 'huge';
    } else if (radius < 256) {
        size = 'gigantic';
    }

    var buttonObject = {
        button: b,
        location: location,
        shape: shape,
        sides: sides,
        radius: radius,
        size: size,
        color: color,
        brightness: brightness
    };
   buttonData.push(buttonObject);
}

// These are important functions!
// This is basically creating the features 
// that I will use to generate mappings and learn models
// BE PREPARED FOR CHANGE
// Just now, I am leery of how hard identifying buttons is going to be...
function subtractButtons(buttonA, buttonB) {
    var result = {
        location: {x: buttonA.x - buttonB.x, y: buttonA.y - buttonB.y},
        shape: buttonA.shape == buttonB.shape,
        sides: buttonA.sides - buttonB.sides,
        radius:  buttonA.radius - buttonB.radius, 
        size: allSizes.indexOf(buttonA.size) - allSizes.indexOf(buttonB.size),
        color:  parseInt(buttonA.color.substring(1, 7), 16) - parseInt(buttonB.color.substring(1, 7), 16),
        brightness: buttonA.brightness - buttonB.brightness
    };
    return result;
}

function generateDifferences() {
    for (var i = 0; i < buttonData.length; i++) {
        butttonDifferences[i] = {};
        for (var j = 0; j < buttonData.length; j++) {
            if (j == i) {
                continue;
            }
            butttonDifferences[i][j] = subtractButtons(buttonData[i], buttonData[j]);
        }
    }
}

//  ellipse, rhombus, parralellogram, trapezoid <-- do I want these?
// I think I do want ellipse.  hrm.
// At some point I want non-regular things like 'cross', etc...
// These need to go into shapes.js

function makeButton(paper, location, color, shape, radius, rotation) {
    var button = buttonFunctions[shape](paper, location, radius, rotation)
    addButton(button, location, color, shape, radius, rotation);
    button.attr("fill", color);
 }

function makeRandomButton(paper) {
    var minDimension = Math.min(paper.width, paper.height);
    var maxRadius = parseInt(minDimension / 3);
    var location = {x: Math.floor((Math.random() * paper.width)), y: Math.floor((Math.random() * paper.height))};
    var color = '#' + Math.floor(Math.random() * 16777215).toString(16);
    var shapeIndex =  Math.floor(Math.random() * allShapes.length);
    var shape = allShapes[shapeIndex];
    var rotation = Math.random() * 2 * Math.PI;
    var radius = {x: Math.floor(Math.random() * maxRadius) + 1, y: Math.floor(Math.random() * maxRadius) + 1};
    makeButton(paper, location, color, shape, radius, rotation);
 }

function makeGrid(paper, startingPoint, width, height, spacing, buttonColor, buttonShape, buttonRadius, buttonRotation) {
    // example:  makeGrid(paper, {x:50, y:50}, 3, 5, {x: 20, y:10}, '#AA0000', 'circle', {x:50, y:50}, 0);
    for (var i = 0; i < width; i++) {
        for (var j = 0; j < height; j++) {
            var x = startingPoint.x + (i * (spacing.x + 2 * buttonRadius.x));
            var y = startingPoint.y + (j * (spacing.y + 2 * buttonRadius.y));
            var location = {x: x, y: y};
            makeButton(paper, location, buttonColor, buttonShape, buttonRadius, buttonRotation);
        }
    }
}

function makeRow(paper, startingPoint, length, spacing, buttonColor, buttonShape, buttonRadius, buttonRotation) {
    // example:  makeRow(paper, {x: 50, y: 100}, 6, 20, '#AA0000', 'circle', {x:50, y:50}, 0);
    for (var i = 0; i < length; i++) {
            var x = startingPoint.x + (i * (spacing + 2 * buttonRadius.x));
            var y = startingPoint.y;
            var location = {x: x, y: y};
            makeButton(paper, location, buttonColor, buttonShape, buttonRadius, buttonRotation);
    } 
}

function makeColumn(paper, startingPoint, length, spacing, buttonColor, buttonShape, buttonRadius, buttonRotation) {
    // example:  makeColumn(paper, {x: 50, y: 100}, 6, 20, '#AA0000', 'circle', {x:50, y:50}, 0);
    for (var i = 0; i < length; i++) {
            var x = startingPoint.x;
            var y = startingPoint.y + (i * (spacing + 2 * buttonRadius.y));
            var location = {x: x, y: y};
            makeButton(paper, location, buttonColor, buttonShape, buttonRadius, buttonRotation);
    } 
}

function makeCircle(paper, startingPoint, radius, spacing, buttonColor, buttonShape, buttonRadius, buttonRotation) {
    // example:  makeCircle(paper, {x:400, y:400}, 200, 20, '#AA0000', 'circle', {x:10, y:10}, 0);

    // the number of buttons I need is determined by the radius of the circle, the spacing of the buttons, and the buttonRadius
    // so I have a radius of 100.  
    // thus i have a circumerfence of 2 * pi * r, so 200pi
    // and each button takes up buttonRadius *2 + spacing
    // so numberOfButtons is:
    //(should be the euclidian hypotenuse of buttonRadius...)

    var angledButtonRadius = Math.sqrt(buttonRadius.x * buttonRadius.x + buttonRadius.y * buttonRadius.y);
    var numberOfButtons = Math.floor((2 * Math.PI * radius) / (angledButtonRadius * 2 + spacing));
    var angle = (2 * Math.PI) / numberOfButtons;
    for (var i = 0; i <= numberOfButtons; i++) {
            var x = radius * Math.sin(i * angle) + startingPoint.x;
            var y = radius * Math.cos(i * angle) + startingPoint.y;
            var location = {x: x, y: y};
            makeButton(paper, location, buttonColor, buttonShape, buttonRadius, buttonRotation);
    } 
}


function basicNoteClick(audioContext, freq) {
    var oscillator = audioContext.createOscillator(); // Oscillator defaults to sine wave
    oscillator.frequency.value = freq;
    var vca = audioContext.createGain();
    vca.gain.value = 0;
    oscillator.connect(vca);
    vca.connect(audioContext.destination)
    oscillator.start(0);
    vca.gain.value = 0.5;
    setTimeout(function(){vca.gain.value = 0; vca.disconnect(); oscillator.disconnect()}, 500);
}

function init() {
    // Creates canvas.
    var screensize = {x: 1024, y:  768}
    var paper = Raphael(0, 0, screensize.x, screensize.y);

    // create webAudio code
    var audioContext = new webkitAudioContext();
   

    // Circle
    makeCircle(paper, {x:400, y:400}, 200, 20, '#AA0000', 'circle', {x:10, y:10}, 0);

    // Create the differences
    generateDifferences();

    // Hyper-rough faux mapping
    for (var i = 0; i < buttonData.length; i++) {
        var freq = buttonData[i].location.x * 2.1828 + buttonData[i].location.y / 1.618;
        var fr = partial(basicNoteClick, audioContext, freq);

        buttonData[i].button.click(fr);
    }

}

window.onload = init;
</script>
</body>
</html>